// =============================================
// C√ÅC BI·∫æN TO√ÄN C·ª§C
// =============================================

const THEME_KEY = 'theme_mode';
const btn = document.getElementById('theme-toggle');

// Danh s√°ch h√¨nh ·∫£nh cho lightbox
const galleryImages = [
    { src: 'anh21.jpg', caption: 'Ho·∫°t ƒë·ªông tr·∫£i nghi·ªám' },
    { src: 'anh22.jpg', caption: 'Ho·∫°t ƒë·ªông l·ªÖ h·ªôi' },
    { src: 'anh23.jpg', caption: 'T·∫≠p th·ªÉ tham gia' },
    { src: 'anh24.jpg', caption: 'Gi·ªõi thi·ªáu di t√≠ch' },
    { src: 'anh2.jpg', caption: 'H·ªçc sinh tr·∫£i nghi·ªám' },
    { src: 'anh3.jpg', caption: 'C√°p treo Y√™n T·ª≠' },
    { src: 'anh14.jpg', caption: 'Ch√πa ƒê·ªìng' },
    { src: 'anh15.jpg', caption: 'T∆∞·ª£ng Ph·∫≠t ho√†ng' }
];

// Bi·∫øn cho lightbox
let currentImageIndex = 0;

// =============================================
// H√ÄM KH·ªûI T·∫†O
// =============================================

// H√†m kh·ªüi t·∫°o t·∫•t c·∫£ c√°c ch·ª©c nƒÉng
function init() {
    initTheme();
    initScrollEffects();
    initLightbox();
    initNavigation();
    setCurrentYear();
    
    console.log('Website ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o th√†nh c√¥ng!');
}

// =============================================
// CH·ª®C NƒÇNG CHUY·ªÇN ƒê·ªîI THEME
// =============================================

// Ki·ªÉm tra h·ªá th·ªëng c√≥ ƒëang ·ªü ch·∫ø ƒë·ªô t·ªëi kh√¥ng
function prefersDark() {
    return window.matchMedia('(prefers-color-scheme:dark)').matches;
}

// √Åp d·ª•ng theme
function applyTheme(mode) {
    document.documentElement.setAttribute('data-theme', 
        mode === 'auto' ? (prefersDark() ? 'dark' : 'light') : mode);
}

// L·∫•y theme ƒë√£ l∆∞u
function getSavedTheme() {
    return localStorage.getItem(THEME_KEY) || 'auto';
}

// Kh·ªüi t·∫°o ch·ª©c nƒÉng theme
function initTheme() {
    if (!btn) return;
    
    // √Åp d·ª•ng theme ƒë√£ l∆∞u
    const savedTheme = getSavedTheme();
    applyTheme(savedTheme);
    updateThemeButton(savedTheme);
    
    // Th√™m s·ª± ki·ªán click cho n√∫t theme
    btn.addEventListener('click', toggleTheme);
}

// Chuy·ªÉn ƒë·ªïi theme
function toggleTheme() {
    const current = getSavedTheme();
    let newTheme;
    
    if (current === 'auto') {
        newTheme = 'light';
    } else if (current === 'light') {
        newTheme = 'dark';
    } else {
        newTheme = 'auto';
    }
    
    localStorage.setItem(THEME_KEY, newTheme);
    applyTheme(newTheme);
    updateThemeButton(newTheme);
}

// C·∫≠p nh·∫≠t bi·ªÉu t∆∞·ª£ng n√∫t theme
function updateThemeButton(theme) {
    if (!btn) return;
    
    if (theme === 'dark') {
        btn.textContent = '‚òÄÔ∏è';
        btn.title = 'Chuy·ªÉn sang ch·∫ø ƒë·ªô s√°ng';
    } else {
        btn.textContent = 'üåô';
        btn.title = 'Chuy·ªÉn sang ch·∫ø ƒë·ªô t·ªëi';
    }
}

// =============================================
// HI·ªÜU ·ª®NG CU·ªòN V√Ä FADE-IN
// =============================================

// Kh·ªüi t·∫°o hi·ªáu ·ª©ng cu·ªôn
function initScrollEffects() {
    initFadeInOnScroll();
    initProgressBar();
    initBackToTop();
}

// Hi·ªáu ·ª©ng fade-in khi cu·ªôn
function initFadeInOnScroll() {
    const faders = document.querySelectorAll('.fade-in, .content-block');
    const observer = new IntersectionObserver(handleIntersection, {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    });

    faders.forEach(fader => observer.observe(fader));
}

// X·ª≠ l√Ω s·ª± ki·ªán khi ph·∫ßn t·ª≠ xu·∫•t hi·ªán trong viewport
function handleIntersection(entries) {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            entry.target.classList.add('visible');
        }
    });
}

// Thanh ti·∫øn tr√¨nh cu·ªôn
function initProgressBar() {
    const progressBar = document.getElementById('progressBar');
    if (!progressBar) return;

    window.addEventListener('scroll', () => {
        const windowHeight = document.documentElement.scrollHeight - 
                            document.documentElement.clientHeight;
        const scrolled = (window.scrollY / windowHeight) * 100;
        progressBar.style.width = scrolled + '%';
    });
}

// N√∫t back to top
function initBackToTop() {
    const backToTop = document.getElementById('backToTop');
    if (!backToTop) return;

    window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
            backToTop.classList.add('active');
        } else {
            backToTop.classList.remove('active');
        }
    });

    backToTop.addEventListener('click', () => {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });
}

// =============================================
// LIGHTBOX CHO TH∆Ø VI·ªÜN ·∫¢NH
// =============================================

// Kh·ªüi t·∫°o lightbox
function initLightbox() {
    // Th√™m s·ª± ki·ªán click cho t·∫•t c·∫£ ·∫£nh trong gallery
    document.querySelectorAll('.gallery img').forEach((img, index) => {
        img.addEventListener('click', () => openLightbox(index));
    });

    // Th√™m s·ª± ki·ªán cho c√°c n√∫t ƒëi·ªÅu khi·ªÉn lightbox
    const lightboxClose = document.getElementById('lightboxClose');
    const lightboxPrev = document.getElementById('lightboxPrev');
    const lightboxNext = document.getElementById('lightboxNext');
    const lightbox = document.getElementById('lightbox');

    if (lightboxClose) {
        lightboxClose.addEventListener('click', closeLightbox);
    }

    if (lightboxPrev) {
        lightboxPrev.addEventListener('click', showPrevImage);
    }

    if (lightboxNext) {
        lightboxNext.addEventListener('click', showNextImage);
    }

    // ƒê√≥ng lightbox khi click b√™n ngo√†i ·∫£nh
    if (lightbox) {
        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox) {
                closeLightbox();
            }
        });
    }

    // ƒêi·ªÅu h∆∞·ªõng b·∫±ng b√†n ph√≠m
    document.addEventListener('keydown', handleKeyboardNavigation);
}

// M·ªü lightbox
function openLightbox(index) {
    currentImageIndex = index;
    updateLightbox();
    
    const lightbox = document.getElementById('lightbox');
    if (lightbox) {
        lightbox.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
}

// ƒê√≥ng lightbox
function closeLightbox() {
    const lightbox = document.getElementById('lightbox');
    if (lightbox) {
        lightbox.classList.remove('active');
        document.body.style.overflow = '';
    }
}

// C·∫≠p nh·∫≠t n·ªôi dung lightbox
function updateLightbox() {
    const lightboxImage = document.getElementById('lightboxImage');
    const lightboxCaption = document.getElementById('lightboxCaption');
    
    if (!lightboxImage || !lightboxCaption) return;
    
    const image = galleryImages[currentImageIndex];
    lightboxImage.src = image.src;
    lightboxImage.alt = image.caption;
    lightboxCaption.textContent = image.caption;
}

// Hi·ªÉn th·ªã ·∫£nh ti·∫øp theo
function showNextImage() {
    currentImageIndex = (currentImageIndex + 1) % galleryImages.length;
    updateLightbox();
}

// Hi·ªÉn th·ªã ·∫£nh tr∆∞·ªõc ƒë√≥
function showPrevImage() {
    currentImageIndex = (currentImageIndex - 1 + galleryImages.length) % galleryImages.length;
    updateLightbox();
}

// X·ª≠ l√Ω ƒëi·ªÅu h∆∞·ªõng b·∫±ng b√†n ph√≠m
function handleKeyboardNavigation(e) {
    const lightbox = document.getElementById('lightbox');
    if (!lightbox || !lightbox.classList.contains('active')) return;
    
    switch(e.key) {
        case 'Escape':
            closeLightbox();
            break;
        case 'ArrowRight':
            showNextImage();
            break;
        case 'ArrowLeft':
            showPrevImage();
            break;
    }
}

// =============================================
// ƒêI·ªÄU H∆Ø·ªöNG V√Ä C√ÅC TI·ªÜN √çCH KH√ÅC
// =============================================

// Kh·ªüi t·∫°o ƒëi·ªÅu h∆∞·ªõng m∆∞·ª£t
function initNavigation() {
    // T·∫°o navigation n·∫øu ch∆∞a c√≥
    createNavigation();
    
    // Th√™m s·ª± ki·ªán cho c√°c li√™n k·∫øt ƒëi·ªÅu h∆∞·ªõng
    document.querySelectorAll('nav a').forEach(anchor => {
        anchor.addEventListener('click', handleNavClick);
    });
}

// T·∫°o thanh ƒëi·ªÅu h∆∞·ªõng
function createNavigation() {
    // Ki·ªÉm tra xem ƒë√£ c√≥ nav ch∆∞a
    if (document.querySelector('nav')) return;
    
    const nav = document.createElement('nav');
    nav.className = 'glass fade-in';
    
    const navItems = [
        { href: '#gioithieu-truong', text: 'Gi·ªõi thi·ªáu' },
        { href: '#tongquan', text: 'T·ªïng quan' },
        { href: '#ditich', text: 'Di t√≠ch' },
        { href: '#giatri', text: 'Gi√° tr·ªã' },
        { href: '#giaiphap', text: 'Gi·∫£i ph√°p' },
        { href: '#thuvien', text: 'Th∆∞ vi·ªán' }
    ];
    
    navItems.forEach(item => {
        const link = document.createElement('a');
        link.href = item.href;
        link.textContent = item.text;
        nav.appendChild(link);
    });
    
    // Ch√®n nav sau header
    const header = document.querySelector('header');
    if (header) {
        header.parentNode.insertBefore(nav, header.nextSibling);
    }
}

// X·ª≠ l√Ω click ƒëi·ªÅu h∆∞·ªõng
function handleNavClick(e) {
    e.preventDefault();
    
    const targetId = this.getAttribute('href');
    const targetElement = document.querySelector(targetId);
    
    if (targetElement) {
        const offsetTop = targetElement.offsetTop - 20;
        
        window.scrollTo({
            top: offsetTop,
            behavior: 'smooth'
        });
        
        // Th√™m hi·ªáu ·ª©ng active cho nav item
        setActiveNavItem(this);
    }
}

// ƒê·∫∑t nav item ƒëang active
function setActiveNavItem(activeItem) {
    document.querySelectorAll('nav a').forEach(item => {
        item.classList.remove('active');
    });
    activeItem.classList.add('active');
}

// C·∫≠p nh·∫≠t nav item active khi cu·ªôn
function updateActiveNavOnScroll() {
    const sections = document.querySelectorAll('section');
    const navLinks = document.querySelectorAll('nav a');
    
    let currentSection = '';
    
    sections.forEach(section => {
        const sectionTop = section.offsetTop - 100;
        const sectionHeight = section.clientHeight;
        
        if (window.scrollY >= sectionTop && 
            window.scrollY < sectionTop + sectionHeight) {
            currentSection = '#' + section.id;
        }
    });
    
    navLinks.forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('href') === currentSection) {
            link.classList.add('active');
        }
    });
}

// ƒê·∫∑t nƒÉm hi·ªán t·∫°i trong footer
function setCurrentYear() {
    const yearElement = document.getElementById('year');
    if (yearElement) {
        yearElement.textContent = new Date().getFullYear();
    }
}

// =============================================
// T·∫†O HI·ªÜU ·ª®NG H·∫†T PARTICLE
// =============================================

function createParticles() {
    const particlesContainer = document.createElement('div');
    particlesContainer.className = 'particles';
    particlesContainer.id = 'particles';
    document.body.prepend(particlesContainer);

    const particleCount = 30;
    
    for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.classList.add('particle');
        
        // Thu·ªôc t√≠nh ng·∫´u nhi√™n
        const size = Math.random() * 5 + 2;
        const left = Math.random() * 100;
        const animationDuration = Math.random() * 20 + 10;
        const animationDelay = Math.random() * 5;
        const opacity = Math.random() * 0.5 + 0.1;
        
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.left = `${left}%`;
        particle.style.animationDuration = `${animationDuration}s`;
        particle.style.animationDelay = `${animationDelay}s`;
        particle.style.opacity = opacity;
        
        particlesContainer.appendChild(particle);
    }
}

// =============================================
// X·ª¨ L√ù S·ª∞ KI·ªÜN LOAD V√Ä RESIZE
// =============================================

// X·ª≠ l√Ω khi trang ƒë√£ t·∫£i xong
document.addEventListener('DOMContentLoaded', () => {
    init();
    createParticles();
});

// X·ª≠ l√Ω khi resize window
window.addEventListener('resize', () => {
    // C√≥ th·ªÉ th√™m c√°c x·ª≠ l√Ω responsive t·∫°i ƒë√¢y
});

// X·ª≠ l√Ω scroll ƒë·ªÉ c·∫≠p nh·∫≠t nav active
window.addEventListener('scroll', () => {
    updateActiveNavOnScroll();
});

// =============================================
// C√ÅC H√ÄM TI·ªÜN √çCH B·ªî SUNG
// =============================================

// H√†m t·∫°o hi·ªáu ·ª©ng typewriter cho ti√™u ƒë·ªÅ
function typeWriter(element, text, speed = 100) {
    let i = 0;
    element.textContent = '';
    
    function type() {
        if (i < text.length) {
            element.textContent += text.charAt(i);
            i++;
            setTimeout(type, speed);
        }
    }
    
    type();
}

// H√†m ki·ªÉm tra xem ph·∫ßn t·ª≠ c√≥ trong viewport kh√¥ng
function isInViewport(element) {
    const rect = element.getBoundingClientRect();
    return (
        rect.top >= 0 &&
        rect.left >= 0 &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
        rect.right <= (window.innerWidth || document.documentElement.clientWidth)
    );
}

// H√†m debounce ƒë·ªÉ t·ªëi ∆∞u hi·ªáu su·∫•t
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// H√†m ƒë·ªãnh d·∫°ng s·ªë (th√™m d·∫•u ph·∫©y)
function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// =============================================
// X·ª¨ L√ù L·ªñI V√Ä FALLBACK
// =============================================

// X·ª≠ l√Ω l·ªói ·∫£nh kh√¥ng t·∫£i ƒë∆∞·ª£c
function handleImageError(img) {
    img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7imqMgU8O1bmggxJHhuqNwIMSR4bqjbiDEkeG6o2k8L3RleHQ+PC9zdmc+';
    img.alt = 'Kh√¥ng th·ªÉ t·∫£i h√¨nh ·∫£nh';
}

// Th√™m s·ª± ki·ªán error cho t·∫•t c·∫£ ·∫£nh
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('img').forEach(img => {
        img.addEventListener('error', () => handleImageError(img));
    });
});

// Fallback cho Intersection Observer
if (!('IntersectionObserver' in window)) {
    console.warn('IntersectionObserver kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£, t·∫•t c·∫£ ph·∫ßn t·ª≠ s·∫Ω hi·ªÉn th·ªã ngay l·∫≠p t·ª©c');
    document.querySelectorAll('.fade-in, .content-block').forEach(el => {
        el.classList.add('visible');
    });
}

// Console log th√¥ng b√°o kh·ªüi t·∫°o th√†nh c√¥ng
console.log(`
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë      D·∫§U ·∫§N ƒê·ªàNH THI√äNG Y√äN T·ª¨      ‚ïë
‚ïë        Tr∆∞·ªùng THCS ƒê√¥ng X√°          ‚ïï
‚ïë                                      ‚ïë
‚ïë  Website ƒë√£ s·∫µn s√†ng! Ch√†o m·ª´ng!    ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
`);